generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Contact {
  id                      String                   @id @default(uuid()) @db.Uuid
  pipelineId              String?                  @map("pipeline_id") @db.Uuid
  fullName                String?                  @map("full_name")
  firstName               String?                  @map("first_name")
  lastName                String?                  @map("last_name")
  llcName                 String?                  @map("llc_name")
  phone1                  String?
  phone2                  String?
  phone3                  String?
  email1                  String?
  email2                  String?
  email3                  String?
  linkedinUrl             String?                  @map("linkedin_url")
  propertyAddress         String?                  @map("property_address")
  fullPropertyAddress     String?                  @map("full_property_address")
  contactAddress          String?                  @map("contact_address")
  contactCityStateZip     String?                  @map("contact_city_state_zip")
  city                    String?
  state                   String?
  zipCode                 String?                  @map("zip_code")
  propertyCounty          String?                  @map("property_county")
  propertyType            String?                  @map("property_type")
  bedrooms                Int?
  totalBathrooms          Decimal?                 @map("total_bathrooms") @db.Decimal(6, 2)
  buildingSqft            Int?                     @map("building_sqft")
  lotSizeSqft             Int?                     @map("lot_size_sqft")
  effectiveYearBuilt      Int?                     @map("effective_year_built")
  lastSaleDate            DateTime?                @map("last_sale_date") @db.Timestamptz(6)
  lastSaleAmount          Decimal?                 @map("last_sale_amount") @db.Decimal(15, 2)
  estRemainingBalance     Decimal?                 @map("est_remaining_balance") @db.Decimal(15, 2)
  estValue                Decimal?                 @map("est_value") @db.Decimal(15, 2)
  estEquity               Decimal?                 @map("est_equity") @db.Decimal(15, 2)
  dnc                     Boolean?                 @default(false)
  dncReason               String?                  @map("dnc_reason")
  dealStatus              DealStatus?              @default(lead) @map("deal_status")
  noAnswerCount           Int                      @default(0) @map("no_answer_count") // Track how many times contact didn't answer in power dialer
  notes                   String?
  avatarUrl               String?                  @map("avatar_url")
  customFields            Json?                    @default("{}") @map("custom_fields")
  createdAt               DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime?                @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt               DateTime?                @map("deleted_at") @db.Timestamptz(6)
  pipeline                Pipeline?                @relation(fields: [pipelineId], references: [id], onDelete: SetNull)
  contact_tags            ContactTag[]
  contact_tag_history     ContactTagHistory[]
  messages                Message[]
  activities              Activity[]
  telnyx_messages         TelnyxMessage[]
  conversations           Conversation[]
  email_messages          EmailMessage[]
  email_conversations     EmailConversation[]
  assignments             ContactAssignment[]
  properties              ContactProperty[]
  powerDialerQueue        PowerDialerQueue[]
  powerDialerCalls        PowerDialerCall[]
  powerDialerListContacts PowerDialerListContact[] @relation("PowerDialerListContacts")
  callCampaignContacts    CallCampaignContact[]
  deals                   Deal[]                   @relation("ContactDeals")
  sequenceEnrollments     SequenceEnrollment[]     @relation("ContactSequenceEnrollments")
  scheduledMessages       ScheduledMessage[]       @relation("ContactScheduledMessages")
  dispositionLogs         CallDispositionLog[]
  clickToCallPending      ClickToCallPending[]     @relation("ContactClickToCallPending")
  textCampaignQueue       TextCampaignQueue[]
  textCampaignMessages    TextCampaignMessage[]

  // Performance indexes for common queries
  @@index([pipelineId], name: "idx_contacts_pipeline_id")
  @@index([createdAt(sort: Desc)], name: "idx_contacts_created_at")
  @@index([firstName, lastName], name: "idx_contacts_name")
  @@index([phone1], name: "idx_contacts_phone1")
  @@index([email1], name: "idx_contacts_email1")
  @@index([dealStatus, createdAt(sort: Desc)], name: "idx_contacts_status_created")
  @@index([city, state], name: "idx_contacts_location")
  @@index([propertyType], name: "idx_contacts_property_type")
  @@index([dnc], name: "idx_contacts_dnc")
  @@index([deletedAt], name: "idx_contacts_deleted_at")
  @@map("contacts")
}

model Tag {
  id            String        @id @default(uuid()) @db.Uuid
  name          String        @unique
  color         String        @default("#3B82F6")
  description   String?
  is_system     Boolean?      @default(false)
  created_at    DateTime      @default(now()) @db.Timestamptz(6)
  updated_at    DateTime      @updatedAt @db.Timestamptz(6)
  contact_tags  ContactTag[]
  activity_tags ActivityTag[]
  Pipeline      Pipeline?     @relation(fields: [pipelineId], references: [id])
  pipelineId    String?       @db.Uuid

  @@map("tags")
}

model ContactTag {
  id         String   @id @default(uuid()) @db.Uuid
  contact_id String   @db.Uuid
  tag_id     String   @db.Uuid
  created_at DateTime @default(now()) @db.Timestamptz(6)
  created_by String?  @db.Uuid
  contact    Contact  @relation(fields: [contact_id], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@unique([contact_id, tag_id])
  @@map("contact_tags")
}

// Track tag additions and removals for activity history
model ContactTagHistory {
  id         String   @id @default(uuid()) @db.Uuid
  contact_id String   @db.Uuid
  tag_id     String   @db.Uuid
  tag_name   String   // Store tag name for historical reference
  action     String   // 'added' or 'removed'
  created_at DateTime @default(now()) @db.Timestamptz(6)
  created_by String?  @db.Uuid
  contact    Contact  @relation(fields: [contact_id], references: [id], onDelete: Cascade)

  @@index([contact_id, created_at])
  @@map("contact_tag_history")
}

model ActivityTag {
  id          String   @id @default(uuid()) @db.Uuid
  activity_id String   @db.Uuid
  tag_id      String   @db.Uuid
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  created_by  String?  @db.Uuid
  activity    Activity @relation(fields: [activity_id], references: [id], onDelete: Cascade)
  tag         Tag      @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@unique([activity_id, tag_id])
  @@map("activity_tags")
}

model Message {
  id              String           @id @default(uuid()) @db.Uuid
  contact_id      String           @db.Uuid
  conversation_id String?
  sent_by         String?          @db.Uuid
  direction       MessageDirection
  content         String
  timestamp       DateTime         @default(now()) @db.Timestamptz(6)
  status          MessageStatus    @default(sent)
  message_type    MessageType?     @default(sms)
  phone_number    String?
  message_sid     String?
  error_code      String?
  error_message   String?
  media_urls      String[]
  cost            Decimal?         @db.Decimal(10, 4)
  segments        Int?             @default(1)
  created_at      DateTime         @default(now()) @db.Timestamptz(6)
  updated_at      DateTime         @updatedAt @db.Timestamptz(6)
  contact         Contact          @relation(fields: [contact_id], references: [id], onDelete: Cascade)
  sentBy          User?            @relation("UserMessages", fields: [sent_by], references: [id], onDelete: SetNull)

  @@map("messages")
}

model Call {
  id                 String        @id @default(uuid()) @db.Uuid
  contact_id         String        @db.Uuid
  direction          CallDirection
  duration           Int?          @default(0)
  timestamp          DateTime      @default(now()) @db.Timestamptz(6)
  status             CallStatus
  call_type          CallType?     @default(voice)
  from_number        String?
  to_number          String?
  call_sid           String?
  recording_url      String?
  recording_duration Int?
  cost               Decimal?      @db.Decimal(10, 4)
  notes              String?
  answered_by        String?
  hangup_cause       String?
  created_at         DateTime      @default(now()) @db.Timestamptz(6)
  updated_at         DateTime      @updatedAt @db.Timestamptz(6)

  @@map("calls")
}

model Email {
  id            String         @id @default(uuid()) @db.Uuid
  contact_id    String         @db.Uuid
  direction     EmailDirection
  subject       String
  body          String
  html_body     String?
  timestamp     DateTime       @default(now()) @db.Timestamptz(6)
  status        EmailStatus    @default(sent)
  from_email    String?
  to_email      String?
  cc_emails     String[]
  bcc_emails    String[]
  reply_to      String?
  message_id    String?
  thread_id     String?
  in_reply_to   String?
  attachments   Json?          @default("[]")
  headers       Json?          @default("{}")
  bounce_reason String?
  spam_score    Decimal?       @db.Decimal(3, 2)
  opened_at     DateTime?      @db.Timestamptz(6)
  clicked_at    DateTime?      @db.Timestamptz(6)
  created_at    DateTime       @default(now()) @db.Timestamptz(6)
  updated_at    DateTime       @updatedAt @db.Timestamptz(6)

  @@map("emails")
}

model Activity {
  id                   String             @id @default(uuid()) @db.Uuid
  pipelineId           String?            @map("pipeline_id") @db.Uuid
  contact_id           String?            @db.Uuid
  deal_id              String?            @db.Uuid
  type                 ActivityType
  task_type            String?
  title                String
  description          String?
  due_date             DateTime?          @db.Timestamptz(6)
  status               ActivityStatus     @default(planned)
  priority             ActivityPriority?  @default(medium)
  assigned_to          String?            @db.Uuid
  created_by           String?            @db.Uuid
  location             String?
  duration_minutes     Int?
  reminder_minutes     Int?
  is_all_day           Boolean?           @default(false)
  recurrence_rule      String?
  parent_activity_id   String?            @db.Uuid
  external_calendar_id String?
  external_event_id    String?
  completed_at         DateTime?          @db.Timestamptz(6)
  completed_by         String?            @db.Uuid
  result               String?
  next_action          String?
  is_pinned            Boolean            @default(false) @map("is_pinned")
  created_at           DateTime           @default(now()) @db.Timestamptz(6)
  updated_at           DateTime           @updatedAt @db.Timestamptz(6)
  pipeline             Pipeline?          @relation(fields: [pipelineId], references: [id], onDelete: SetNull)
  contact              Contact?           @relation(fields: [contact_id], references: [id], onDelete: Cascade)
  createdBy            User?              @relation("UserActivities", fields: [created_by], references: [id], onDelete: SetNull)
  assignedUser         User?              @relation("AssignedTasks", fields: [assigned_to], references: [id], onDelete: SetNull)
  activity_tags        ActivityTag[]
  comments             TaskComment[]      @relation("ActivityComments")
  attachments          TaskAttachment[]   @relation("ActivityAttachments")
  timeEntries          TaskTimeEntry[]    @relation("ActivityTimeEntries")
  dependsOnTasks       TaskDependency[]   @relation("DependsOn")
  dependentTasks       TaskDependency[]   @relation("DependentOn")
  notifications        TaskNotification[] @relation("ActivityNotifications")
  replies              TaskReply[]        @relation("TaskReplies")

  @@index([contact_id, due_date], name: "idx_activities_contact_due")
  @@index([created_by, created_at(sort: Desc)], name: "idx_activities_created_by")
  @@index([status, due_date], name: "idx_activities_status_due")
  @@index([assigned_to, due_date], name: "idx_activities_assigned_due")
  @@map("activities")
}

// Task Templates
model TaskTemplate {
  id              String            @id @default(uuid()) @db.Uuid
  pipelineId      String?           @map("pipeline_id") @db.Uuid
  userId          String            @db.Uuid
  name            String
  description     String?
  type            ActivityType
  priority        ActivityPriority?
  durationMinutes Int?
  reminderMinutes Int?
  tags            String[]
  createdAt       DateTime          @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime          @updatedAt @db.Timestamptz(6)

  pipeline Pipeline? @relation(fields: [pipelineId], references: [id], onDelete: SetNull)
  user     User      @relation("UserTaskTemplates", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([pipelineId])
  @@map("task_templates")
}

// Task Comments
model TaskComment {
  id         String   @id @default(uuid()) @db.Uuid
  activityId String   @db.Uuid
  userId     String   @db.Uuid
  content    String
  mentions   String[] // User IDs mentioned
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)

  activity Activity @relation("ActivityComments", fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation("UserTaskComments", fields: [userId], references: [id], onDelete: Cascade)

  @@index([activityId])
  @@index([userId])
  @@map("task_comments")
}

// Task Replies (for team member responses)
model TaskReply {
  id          String   @id @default(uuid()) @db.Uuid
  activityId  String   @db.Uuid
  userId      String   @db.Uuid
  content     String
  status      String? // "completed", "in_progress", "issue", "blocked", "on_hold"
  attachments String[] // File URLs
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  activity Activity @relation("TaskReplies", fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation("UserTaskReplies", fields: [userId], references: [id], onDelete: Cascade)

  @@index([activityId])
  @@index([userId])
  @@map("task_replies")
}

// Task Attachments
model TaskAttachment {
  id         String   @id @default(uuid()) @db.Uuid
  activityId String   @db.Uuid
  fileName   String
  fileUrl    String
  fileSize   Int
  mimeType   String
  uploadedBy String   @db.Uuid
  createdAt  DateTime @default(now()) @db.Timestamptz(6)

  activity Activity @relation("ActivityAttachments", fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation("UserTaskAttachments", fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([activityId])
  @@index([uploadedBy])
  @@map("task_attachments")
}

// Task Time Entries
model TaskTimeEntry {
  id          String   @id @default(uuid()) @db.Uuid
  activityId  String   @db.Uuid
  userId      String   @db.Uuid
  minutes     Int
  description String?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)

  activity Activity @relation("ActivityTimeEntries", fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation("UserTaskTimeEntries", fields: [userId], references: [id], onDelete: Cascade)

  @@index([activityId])
  @@index([userId])
  @@map("task_time_entries")
}

// Task Dependencies
model TaskDependency {
  id             String   @id @default(uuid()) @db.Uuid
  dependsOnId    String   @db.Uuid
  dependentId    String   @db.Uuid
  dependencyType String // "blocks", "blocked_by", "related"
  createdAt      DateTime @default(now()) @db.Timestamptz(6)

  dependsOn Activity @relation("DependsOn", fields: [dependsOnId], references: [id], onDelete: Cascade)
  dependent Activity @relation("DependentOn", fields: [dependentId], references: [id], onDelete: Cascade)

  @@unique([dependsOnId, dependentId])
  @@index([dependsOnId])
  @@index([dependentId])
  @@map("task_dependencies")
}

// Task Notifications
model TaskNotification {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  activityId String   @map("activity_id") @db.Uuid
  type       String // "due_soon", "overdue", "assigned", "mentioned"
  read       Boolean  @default(false)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)

  user     User     @relation("UserTaskNotifications", fields: [userId], references: [id], onDelete: Cascade)
  activity Activity @relation("ActivityNotifications", fields: [activityId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([activityId])
  @@map("task_notifications")
}

// Task Workflows/Automation
model TaskWorkflow {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  name      String
  trigger   String // "deal_stage_change", "contact_import", etc.
  condition Json? // Conditional logic
  action    Json // What to do
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  user User @relation("UserTaskWorkflows", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, enabled])
  @@map("task_workflows")
}

model Deal {
  id                  String    @id @default(uuid()) @db.Uuid
  contact_id          String    @db.Uuid
  name                String
  stage               DealStage @default(lead) // Legacy enum field - kept for backward compatibility
  value               Decimal   @default(0) @db.Decimal(15, 2)
  probability         Int?      @default(0)
  expected_close_date DateTime? @db.Date
  actual_close_date   DateTime? @db.Date
  source              String?
  campaign            String?
  lead_score          Int?      @default(0)
  assigned_to         String?   @db.Uuid
  team_id             String?   @db.Uuid
  pipeline            String?   @default("default")
  lost_reason         String?
  won_reason          String?
  competitor          String?
  next_step           String?
  notes               String?
  custom_fields       Json?     @default("{}")
  created_at          DateTime  @default(now()) @db.Timestamptz(6)
  updated_at          DateTime  @updatedAt @db.Timestamptz(6)
  Pipeline            Pipeline? @relation(fields: [pipelineId], references: [id])
  pipelineId          String?   @db.Uuid

  // New fields for Deals + Loan Copilot integration
  stageId             String?   @map("stage_id") @db.Uuid // Reference to DealPipelineStage
  lenderId            String?   @map("lender_id") @db.Uuid // Reference to Lender
  llcName             String?   @map("llc_name") @db.VarChar(255) // Borrowing entity / LLC
  propertyAddress     String?   @map("property_address")
  propertyCity        String?   @map("property_city") @db.VarChar(100)
  propertyState       String?   @map("property_state") @db.VarChar(50)
  propertyZip         String?   @map("property_zip") @db.VarChar(20)
  propertyType        String?   @map("property_type") @db.VarChar(50) // SFR, Multi-family, Condo, etc.
  loanAmount          Decimal?  @map("loan_amount") @db.Decimal(15, 2)
  propertyValue       Decimal?  @map("property_value") @db.Decimal(15, 2)
  ltv                 Decimal?  @db.Decimal(5, 2) // Loan-to-value ratio
  loanType            String?   @map("loan_type") @db.VarChar(50) // Purchase, Refinance, Cash Out
  interestRate        Decimal?  @map("interest_rate") @db.Decimal(5, 3)
  dscr                Decimal?  @db.Decimal(5, 2) // Debt Service Coverage Ratio
  isLoanDeal          Boolean   @default(false) @map("is_loan_deal") // Flag to identify loan deals

  // DSCR and rental income fields
  isOccupied          Boolean?  @default(false) @map("is_occupied") // Vacant or Occupied
  marketRent          Decimal?  @map("market_rent") @db.Decimal(10, 2) // Market estimated monthly rent
  actualRent          Decimal?  @map("actual_rent") @db.Decimal(10, 2) // Actual monthly rent (if occupied)
  annualInsurance     Decimal?  @map("annual_insurance") @db.Decimal(10, 2) // Annual insurance cost
  annualTaxes         Decimal?  @map("annual_taxes") @db.Decimal(10, 2) // Annual property taxes
  loanNumber          String?   @map("loan_number") @db.VarChar(50) // Loan identifier

  // Loan terms
  loanTerm            String?   @map("loan_term") @db.VarChar(50) // 5/1 ARM, 7/1 ARM, 30yr fixed
  isInterestOnly      Boolean?  @default(false) @map("is_interest_only") // IO toggle
  prepayPenalty       String?   @map("prepay_penalty") @db.VarChar(50) // 1yr@1%, 3-2-1, etc.
  points              Decimal?  @db.Decimal(5, 2) // Points on the deal

  // Extended loan data (fees, custom line items, etc.)
  loanCopilotData     Json?     @map("loan_copilot_data")

  // Relations
  dealStage      DealPipelineStage?  @relation("DealPipelineStage", fields: [stageId], references: [id])
  lender         Lender?             @relation("DealLender", fields: [lenderId], references: [id])
  contact        Contact             @relation("ContactDeals", fields: [contact_id], references: [id], onDelete: Cascade)
  checklistItems LoanChecklistItem[] @relation("DealChecklistItems")
  loanDocuments  LoanDocument[]      @relation("DealLoanDocuments")

  @@index([contact_id])
  @@index([stageId])
  @@index([lenderId])
  @@index([isLoanDeal])
  @@map("deals")
}

model DealTag {
  id         String   @id @default(uuid()) @db.Uuid
  deal_id    String   @db.Uuid
  tag_id     String   @db.Uuid
  created_at DateTime @default(now()) @db.Timestamptz(6)
  created_by String?  @db.Uuid

  @@unique([deal_id, tag_id])
  @@map("deal_tags")
}

model DealStageHistory {
  id                String                   @id @default(uuid()) @db.Uuid
  deal_id           String                   @db.Uuid
  old_stage         String?
  new_stage         String
  old_value         Decimal?                 @db.Decimal(15, 2)
  new_value         Decimal?                 @db.Decimal(15, 2)
  old_probability   Int?
  new_probability   Int?
  changed_by        String?                  @db.Uuid
  change_reason     String?
  notes             String?
  duration_in_stage Unsupported("interval")?
  changed_at        DateTime                 @default(now()) @db.Timestamptz(6)

  @@map("deal_stage_history")
}

model Document {
  id                 String        @id @default(uuid()) @db.Uuid
  contact_id         String?       @db.Uuid
  deal_id            String?       @db.Uuid
  activity_id        String?       @db.Uuid
  name               String
  original_name      String?
  file_path          String
  file_size          Int?
  mime_type          String?
  file_extension     String?
  document_type      DocumentType?
  category           String?
  description        String?
  is_public          Boolean?      @default(false)
  is_archived        Boolean?      @default(false)
  version            Int?          @default(1)
  parent_document_id String?       @db.Uuid
  checksum           String?
  uploaded_by        String?       @db.Uuid
  uploaded_at        DateTime      @default(now()) @db.Timestamptz(6)
  last_accessed_at   DateTime?     @db.Timestamptz(6)
  access_count       Int?          @default(0)
  tags               String[]
  metadata           Json?         @default("{}")
  created_at         DateTime      @default(now()) @db.Timestamptz(6)
  updated_at         DateTime      @updatedAt @db.Timestamptz(6)

  @@map("documents")
}

// Loan Document categories for checklist items
enum LoanDocCategory {
  BORROWER
  PROPERTY
  TITLE
  INSURANCE
  OTHER
}

// Loan Checklist Item - tracks required documents for a loan deal
model LoanChecklistItem {
  id          String           @id @default(uuid()) @db.Uuid
  dealId      String           @map("deal_id") @db.Uuid
  label       String           @db.VarChar(255)
  category    LoanDocCategory  @default(OTHER)
  required    Boolean          @default(false)
  completed   Boolean          @default(false)
  notes       String?
  orderIndex  Int              @default(0) @map("order_index")
  createdAt   DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  deal        Deal             @relation("DealChecklistItems", fields: [dealId], references: [id], onDelete: Cascade)
  documents   LoanDocument[]   @relation("ChecklistItemDocuments")

  @@index([dealId])
  @@map("loan_checklist_items")
}

// Loan Document - individual files uploaded against a checklist item
model LoanDocument {
  id              String            @id @default(uuid()) @db.Uuid
  checklistItemId String            @map("checklist_item_id") @db.Uuid
  dealId          String            @map("deal_id") @db.Uuid
  originalName    String            @map("original_name") @db.VarChar(255)
  storedName      String            @map("stored_name") @db.VarChar(255)
  filePath        String            @map("file_path")
  fileSize        Int?              @map("file_size")
  mimeType        String?           @map("mime_type") @db.VarChar(100)
  fileExtension   String?           @map("file_extension") @db.VarChar(20)
  uploadedBy      String?           @map("uploaded_by") @db.Uuid
  uploadedAt      DateTime          @default(now()) @map("uploaded_at") @db.Timestamptz(6)
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  checklistItem   LoanChecklistItem @relation("ChecklistItemDocuments", fields: [checklistItemId], references: [id], onDelete: Cascade)
  deal            Deal              @relation("DealLoanDocuments", fields: [dealId], references: [id], onDelete: Cascade)

  @@index([checklistItemId])
  @@index([dealId])
  @@map("loan_documents")
}

model Conversation {
  id                     String                @id @default(uuid()) @db.Uuid
  contact_id             String                @db.Uuid
  phone_number           String // Prospect's phone number (E.164)
  our_number             String?               @map("our_number") // Our Telnyx line (E.164)
  channel                ConversationChannel?  @default(sms)
  last_message_id        String?               @db.Uuid
  last_message_content   String?
  last_message_at        DateTime?             @db.Timestamptz(6)
  last_message_direction MessageDirection?
  last_sender_number     String?               @map("last_sender_number")
  message_count          Int?                  @default(0)
  unread_count           Int?                  @default(0)
  is_archived            Boolean?              @default(false)
  is_starred             Boolean?              @default(false)
  is_muted               Boolean?              @default(false)
  assigned_to            String?               @db.Uuid
  status                 ConversationStatus?   @default(active)
  priority               ConversationPriority? @default(normal)
  labels                 String[]
  metadata               Json?                 @default("{}")
  created_at             DateTime              @default(now()) @db.Timestamptz(6)
  updated_at             DateTime              @updatedAt @db.Timestamptz(6)
  contact                Contact               @relation(fields: [contact_id], references: [id], onDelete: Cascade)

  @@unique([contact_id, phone_number])
  @@index([contact_id], name: "idx_conversations_contact")
  @@index([last_message_at(sort: Desc)], name: "idx_conversations_last_message")
  @@index([unread_count], name: "idx_conversations_unread")
  @@index([assigned_to], name: "idx_conversations_assigned")
  @@index([our_number], name: "idx_conversations_our_number")
  @@map("conversations")
}

model Assistant {
  id                               String                  @id @default(uuid()) @db.Uuid
  name                             String
  description                      String?
  first_message                    String?
  system_prompt                    String?
  model_provider                   AssistantModelProvider? @default(openai)
  model                            String?                 @default("gpt-3.5-turbo")
  voice_provider                   AssistantVoiceProvider? @default(playht)
  voice_id                         String?
  voice_settings                   Json?                   @default("{}")
  language                         String?                 @default("en")
  response_delay_seconds           Decimal?                @db.Decimal(4, 2)
  llm_request_delay_seconds        Decimal?                @db.Decimal(4, 2)
  interruption_threshold           Int?                    @default(100)
  max_duration_seconds             Int?                    @default(1800)
  silence_timeout_seconds          Int?                    @default(30)
  background_sound                 String?                 @default("office")
  backchaneling_enabled            Boolean?                @default(false)
  background_denoising_enabled     Boolean?                @default(true)
  model_output_in_messages_enabled Boolean?                @default(false)
  transport_configurations         Json?                   @default("{}")
  recording_enabled                Boolean?                @default(true)
  video_recording_enabled          Boolean?                @default(false)
  end_call_message                 String?
  end_call_phrases                 String[]
  voicemail_detection_enabled      Boolean?                @default(true)
  voicemail_message                String?
  analysis_plan                    Json?                   @default("{}")
  artifact_plan                    Json?                   @default("{}")
  message_plan                     Json?                   @default("{}")
  start_speaking_plan              Json?                   @default("{}")
  stop_speaking_plan               Json?                   @default("{}")
  monitor_plan                     Json?                   @default("{}")
  credential_ids                   Json?                   @default("{}")
  server_url                       String?
  server_url_secret                String?
  is_active                        Boolean?                @default(true)
  usage_count                      Int?                    @default(0)
  success_rate                     Decimal?                @db.Decimal(5, 2)
  average_duration                 Int?                    @default(0)
  metadata                         Json?                   @default("{}")
  created_at                       DateTime                @default(now()) @db.Timestamptz(6)
  updated_at                       DateTime                @updatedAt @db.Timestamptz(6)

  @@map("assistants")
}

model PhoneNumber {
  id                       String               @id @default(uuid()) @db.Uuid
  number                   String               @unique
  formatted_number         String?
  country_code             String?              @default("+1")
  area_code                String?
  name                     String?
  provider                 PhoneNumberProvider? @default(twilio)
  provider_account_sid     String?
  provider_phone_number_id String?
  assistant_id             String?              @db.Uuid
  squad_id                 String?              @db.Uuid
  server_url               String?
  server_url_secret        String?
  capabilities             String[]             @default(["voice", "sms"])
  voice_settings           Json?                @default("{}")
  sms_settings             Json?                @default("{}")
  fallback_destination     String?
  is_active                Boolean?             @default(true)
  is_verified              Boolean?             @default(false)
  purchase_date            DateTime?            @db.Date
  monthly_cost             Decimal?             @db.Decimal(8, 2)
  usage_count              Int?                 @default(0)
  last_used_at             DateTime?            @db.Timestamptz(6)
  metadata                 Json?                @default("{}")
  created_at               DateTime             @default(now()) @db.Timestamptz(6)
  updated_at               DateTime             @updatedAt @db.Timestamptz(6)

  @@map("phone_numbers")
}

model VapiApiKey {
  id                 String    @id @default(uuid()) @db.Uuid
  name               String    @map("name")
  apiKey             String    @map("api_key") // Encrypted
  isActive           Boolean   @default(true) @map("is_active")
  isDefault          Boolean   @default(false) @map("is_default")
  defaultAssistantId String?   @map("default_assistant_id")
  defaultPhoneNumber String?   @map("default_phone_number")
  maxCallDuration    Int?      @default(600) @map("max_call_duration") // in seconds
  recordingEnabled   Boolean   @default(true) @map("recording_enabled")
  transcriptEnabled  Boolean   @default(true) @map("transcript_enabled")
  webhookUrl         String?   @map("webhook_url")
  webhookSecret      String?   @map("webhook_secret") // Encrypted
  metadata           Json?     @default("{}")
  lastTestedAt       DateTime? @map("last_tested_at") @db.Timestamptz(6)
  testStatus         String?   @map("test_status") // "success", "failed", "pending"
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isActive], name: "idx_vapi_api_keys_is_active")
  @@index([isDefault], name: "idx_vapi_api_keys_is_default")
  @@map("vapi_api_keys")
}

model VapiCall {
  id                             String             @id @default(uuid()) @db.Uuid
  vapi_call_id                   String?            @unique
  org_id                         String?
  assistant_id                   String?            @db.Uuid
  assistant_overrides            Json?              @default("{}")
  squad_id                       String?            @db.Uuid
  phone_number_id                String?            @db.Uuid
  customer_id                    String?            @db.Uuid
  name                           String?
  type                           VapiCallType
  status                         VapiCallStatus?    @default(queued)
  ended_reason                   String?
  messages                       Json?              @default("[]")
  messages_openai_formatted      Json?              @default("[]")
  phone_call_provider            VapiCallProvider?  @default(twilio)
  phone_call_provider_id         String?
  phone_call_transport           VapiCallTransport? @default(pstn)
  phone_call_provider_details    Json?              @default("{}")
  started_at                     DateTime?          @db.Timestamptz(6)
  ended_at                       DateTime?          @db.Timestamptz(6)
  duration                       Int?
  cost                           Decimal?           @db.Decimal(10, 4)
  cost_breakdown                 Json?              @default("{}")
  transcript                     String?
  transcript_searchable          String?            @map("transcript_searchable") // For full-text search
  keywords                       String[]           @default([])
  recording_url                  String?
  stereo_recording_url           String?
  mono_recording_url             String?
  summary                        String?
  analysis                       Json?              @default("{}")
  artifacts                      Json?              @default("[]")
  monitor                        Json?              @default("{}")
  credential_ids_used            Json?              @default("{}")
  transport_configuration_twilio Json?              @default("{}")
  transport_configuration_vonage Json?              @default("{}")
  transport_configuration_vapi   Json?              @default("{}")

  // Call outcome & notes
  callOutcome      String?   @map("call_outcome")
  callNotes        String?   @map("call_notes")
  dispositionSetAt DateTime? @map("disposition_set_at") @db.Timestamptz(6)
  dispositionSetBy String?   @map("disposition_set_by") @db.Uuid

  // Automation tracking
  automationTriggered Boolean? @default(false) @map("automation_triggered")
  automationActions   Json?    @default("[]") @map("automation_actions")

  // Sentiment analysis
  sentiment        String? // positive, neutral, negative
  sentimentScore   Int?    @map("sentiment_score") // 0-100
  sentimentSummary String? @map("sentiment_summary")

  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @updatedAt @db.Timestamptz(6)

  @@index([callOutcome], name: "idx_vapi_calls_outcome")
  @@index([sentiment], name: "idx_vapi_calls_sentiment")
  @@index([created_at(sort: Desc)], name: "idx_vapi_calls_created")
  @@map("vapi_calls")
}

model ImportHistory {
  id                            String   @id @default(uuid()) @db.Uuid
  fileName                      String?  @map("file_name")
  fileUrl                       String?  @map("file_url") // S3 or local path to uploaded file
  tags                          String[] @default([]) // Tags to apply to imported contacts
  importedAt                    DateTime @default(now()) @map("imported_at")
  totalRecords                  Int?     @map("total_records")
  importedCount                 Int?     @map("imported_count") // Total imported (new contacts + new properties)
  newContactsCount              Int?     @map("new_contacts_count") // Brand new contacts created
  existingContactsNewProperties Int?     @map("existing_contacts_new_properties") // Existing contacts with new properties added
  noPhoneEnrichedCount          Int?     @map("no_phone_enriched_count") // No-phone rows matched via name+city/state
  duplicateCount                Int?     @map("duplicate_count") // True duplicates (same phone + same property)
  missingPhoneCount             Int?     @map("missing_phone_count") // Rows with no valid phone (no match found)
  ambiguousMatchCount           Int?     @map("ambiguous_match_count") // No-phone rows with ambiguous matches
  skippedOtherCount             Int?     @map("skipped_other_count") // Skipped for other reasons
  errors                        Json?

  @@map("import_history")
}

model ContactProperty {
  id                 String    @id @default(uuid()) @db.Uuid
  contactId          String    @map("contact_id") @db.Uuid
  contact            Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  address            String?   @map("address")
  city               String?
  state              String?
  zipCode            String?   @map("zip_code")
  county             String?   @map("county")
  llcName            String?   @map("llc_name")
  propertyType       String?   @map("property_type")
  bedrooms           Int?
  totalBathrooms     Int?      @map("total_bathrooms")
  buildingSqft       Int?      @map("building_sqft")
  lotSizeSqft        Int?      @map("lot_size_sqft")
  effectiveYearBuilt Int?      @map("effective_year_built")
  lastSaleDate       DateTime? @map("last_sale_date") @db.Date
  lastSaleAmount     Int?      @map("last_sale_amount")
  estValue           Int?      @map("est_value")
  estEquity          Int?      @map("est_equity")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([contactId], name: "idx_contact_properties_contact_id")
  @@map("contact_properties")
}

// Custom Field Definitions - Pipedrive-style dynamic fields
model FieldDefinition {
  id           String    @id @default(uuid()) @db.Uuid
  name         String // Display name (e.g., "Customer Source")
  fieldKey     String    @unique @map("field_key") // Unique key (e.g., "customer_source")
  fieldType    FieldType @map("field_type") // text, number, date, select, multiselect, etc.
  category     String? // Group fields (e.g., "Basic", "Property", "Financial")
  options      Json? // For select/multiselect: ["Option 1", "Option 2"]
  isRequired   Boolean   @default(false) @map("is_required")
  isSystem     Boolean   @default(false) @map("is_system") // System fields can't be deleted
  isActive     Boolean   @default(true) @map("is_active")
  displayOrder Int?      @map("display_order")
  placeholder  String?
  helpText     String?   @map("help_text")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isActive, displayOrder])
  @@map("field_definitions")
}

model TelnyxPhoneNumber {
  id             String    @id @default(uuid()) @db.Uuid
  phoneNumber    String    @unique @map("phone_number")
  friendlyName   String?   @map("friendly_name")
  telnyxId       String?   @map("telnyx_id")
  state          String?
  city           String?
  country        String    @default("US")
  isActive       Boolean   @default(true) @map("is_active")
  capabilities   String[]  @default(["SMS", "VOICE"])
  monthlyPrice   Decimal?  @map("monthly_price") @db.Decimal(8, 2)
  setupPrice     Decimal?  @map("setup_price") @db.Decimal(8, 2)
  purchasedAt    DateTime  @default(now()) @map("purchased_at")
  lastUsedAt     DateTime? @map("last_used_at")
  totalSmsCount  Int       @default(0) @map("total_sms_count")
  totalCallCount Int       @default(0) @map("total_call_count")
  totalCost      Decimal   @default(0) @map("total_cost") @db.Decimal(10, 4)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations for user permissions
  allowedUsers       UserAllowedPhoneNumber[]
  defaultForUsers    User[]                    @relation("DefaultPhoneNumber")

  @@map("telnyx_phone_numbers")
}

// Join table for many-to-many relationship between User and TelnyxPhoneNumber
model UserAllowedPhoneNumber {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  phoneNumberId String   @map("phone_number_id") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")

  user        User             @relation("UserAllowedNumbers", fields: [userId], references: [id], onDelete: Cascade)
  phoneNumber TelnyxPhoneNumber @relation(fields: [phoneNumberId], references: [id], onDelete: Cascade)

  @@unique([userId, phoneNumberId])
  @@index([userId])
  @@index([phoneNumberId])
  @@map("user_allowed_phone_numbers")
}

model TelnyxMessage {
  id              String              @id @default(uuid()) @db.Uuid
  telnyxMessageId String?             @unique @map("telnyx_message_id")
  contactId       String?             @map("contact_id") @db.Uuid
  fromNumber      String              @map("from_number")
  toNumber        String              @map("to_number")
  direction       MessageDirection
  content         String
  status          TelnyxMessageStatus @default(queued)
  cost            Decimal?            @db.Decimal(10, 4)
  segments        Int?                @default(1)
  errorCode       String?             @map("error_code")
  errorMessage    String?             @map("error_message")
  deliveredAt     DateTime?           @map("delivered_at")
  failedAt        DateTime?           @map("failed_at")
  readAt          DateTime?           @map("read_at")
  webhookData     Json?               @map("webhook_data")
  blastId         String?             @map("blast_id") @db.Uuid
  automationId    String?             @map("automation_id") @db.Uuid
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  contact         Contact?            @relation(fields: [contactId], references: [id], onDelete: Cascade)
  automation      TextAutomation?     @relation("AutomationMessages", fields: [automationId], references: [id], onDelete: SetNull)

  @@index([contactId, createdAt(sort: Desc)], name: "idx_telnyx_messages_contact_created")
  @@index([fromNumber], name: "idx_telnyx_messages_from")
  @@index([toNumber], name: "idx_telnyx_messages_to")
  @@index([direction, createdAt(sort: Desc)], name: "idx_telnyx_messages_direction_created")
  @@map("telnyx_messages")
}

model TelnyxCall {
  id              String           @id @default(uuid()) @db.Uuid
  telnyxCallId    String?          @unique @map("telnyx_call_id")
  telnyxSessionId String?          @unique @map("telnyx_session_id")
  contactId       String?          @map("contact_id") @db.Uuid
  initiatedBy     String?          @map("initiated_by") @db.Uuid
  fromNumber      String           @map("from_number")
  toNumber        String           @map("to_number")
  direction       CallDirection
  status          TelnyxCallStatus @default(initiated)
  duration        Int?             @default(0) // in seconds
  cost            Decimal?         @db.Decimal(10, 4)
  recordingUrl    String?          @map("recording_url")
  answeredAt      DateTime?        @map("answered_at")
  endedAt         DateTime?        @map("ended_at")
  hangupCause     String?          @map("hangup_cause")
  webhookData     Json?            @map("webhook_data")

  // Call outcome & notes
  callOutcome      String?   @map("call_outcome") // interested, not_interested, callback, voicemail, wrong_number, no_answer, busy
  callNotes        String?   @map("call_notes")
  dispositionSetAt DateTime? @map("disposition_set_at") @db.Timestamptz(6)
  dispositionSetBy String?   @map("disposition_set_by") @db.Uuid

  // Automation tracking
  automationTriggered Boolean? @default(false) @map("automation_triggered")
  automationActions   Json?    @default("[]") @map("automation_actions")

  // Sentiment analysis
  sentiment        String? // positive, neutral, negative
  sentimentScore   Int?    @map("sentiment_score") // 0-100
  sentimentSummary String? @map("sentiment_summary")

  // Transcript & search
  transcript           String?
  transcriptSearchable String?  @map("transcript_searchable") // For full-text search
  keywords             String[] @default([])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  initiatedByUser User? @relation("UserCalls", fields: [initiatedBy], references: [id], onDelete: SetNull)

  @@index([telnyxSessionId])
  @@index([contactId, createdAt(sort: Desc)], name: "idx_telnyx_calls_contact_created")
  @@index([fromNumber], name: "idx_telnyx_calls_from")
  @@index([toNumber], name: "idx_telnyx_calls_to")
  @@index([direction, createdAt(sort: Desc)], name: "idx_telnyx_calls_direction_created")
  @@index([callOutcome], name: "idx_telnyx_calls_outcome")
  @@index([sentiment], name: "idx_telnyx_calls_sentiment")
  @@index([createdAt(sort: Desc)], name: "idx_telnyx_calls_created")
  @@map("telnyx_calls")
}

model TelnyxBilling {
  id          String            @id @default(uuid()) @db.Uuid
  phoneNumber String            @map("phone_number")
  recordType  TelnyxBillingType @map("record_type")
  recordId    String            @map("record_id") // message_id or call_id
  cost        Decimal           @db.Decimal(10, 4)
  currency    String            @default("USD")
  billingDate DateTime          @map("billing_date")
  description String?
  metadata    Json?
  createdAt   DateTime          @default(now()) @map("created_at")

  @@map("telnyx_billing")
}

model TelnyxCdrReconcileJob {
  id              String          @id @default(uuid()) @db.Uuid
  telnyxCallId    String?         @map("telnyx_call_id")
  telnyxSessionId String?         @map("telnyx_session_id")
  status          ReconcileStatus @default(pending)
  attempts        Int             @default(0)
  nextRunAt       DateTime        @db.Timestamptz(6)
  lastError       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([status, nextRunAt])
  @@index([telnyxSessionId])
  @@index([telnyxCallId])
  @@map("telnyx_cdr_reconcile_jobs")
}

enum ReconcileStatus {
  pending
  running
  completed
  failed
}

model TextBlast {
  id               String          @id @default(uuid()) @db.Uuid
  name             String?
  message          String
  totalContacts    Int             @map("total_contacts")
  sentCount        Int             @default(0) @map("sent_count")
  deliveredCount   Int             @default(0) @map("delivered_count")
  failedCount      Int             @default(0) @map("failed_count")
  status           TextBlastStatus @default(draft)
  senderNumbers    Json            @map("sender_numbers") // Array of phone numbers
  delaySeconds     Int             @default(1) @map("delay_seconds")
  contactFilters   Json?           @map("contact_filters") // Store filter criteria
  selectedContacts Json?           @map("selected_contacts") // Store contact IDs
  currentIndex     Int             @default(0) @map("current_index")
  isPaused         Boolean         @default(false) @map("is_paused")
  startedAt        DateTime?       @map("started_at")
  completedAt      DateTime?       @map("completed_at")
  pausedAt         DateTime?       @map("paused_at")
  resumedAt        DateTime?       @map("resumed_at")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  // Relations
  createdBy        String?         @map("created_by") @db.Uuid
  createdByUser    User?           @relation("UserTextBlasts", fields: [createdBy], references: [id], onDelete: SetNull)
  Pipeline         Pipeline?       @relation(fields: [pipelineId], references: [id])
  pipelineId       String?         @db.Uuid

  @@index([status])
  @@index([createdBy])
  @@index([createdAt(sort: Desc)])
  @@map("text_blasts")
}

model MessageTemplate {
  id          String   @id @default(uuid()) @db.Uuid
  pipelineId  String?  @map("pipeline_id") @db.Uuid
  name        String
  content     String   @db.Text
  variables   Json     @default("[]") // Array of variable names like ["firstName", "lastName"]
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  usageCount  Int      @default(0) @map("usage_count") // Track how often template is used
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  pipeline Pipeline? @relation(fields: [pipelineId], references: [id], onDelete: SetNull)

  @@index([pipelineId])
  @@map("message_templates")
}

model TextAutomation {
  id               String                  @id @default(uuid()) @db.Uuid
  name             String?
  message          String                  @db.Text
  totalContacts    Int                     @map("total_contacts")
  currentCycle     Int                     @default(1) @map("current_cycle")
  totalCycles      Int?                    @map("total_cycles")
  isIndefinite     Boolean                 @default(true) @map("is_indefinite")
  status           TextAutomationStatus    @default(draft)
  messageDelay     Int                     @default(1) @map("message_delay") // seconds
  loopDelay        Int                     @default(1) @map("loop_delay")
  loopDelayUnit    TextAutomationDelayUnit @default(weeks) @map("loop_delay_unit")
  senderNumbers    Json                    @map("sender_numbers") // Array of phone numbers
  selectedContacts Json                    @map("selected_contacts") // Array of contact IDs
  contactFilters   Json?                   @map("contact_filters") // Store filter criteria
  currentIndex     Int                     @default(0) @map("current_index")
  sentCount        Int                     @default(0) @map("sent_count")
  deliveredCount   Int                     @default(0) @map("delivered_count")
  failedCount      Int                     @default(0) @map("failed_count")
  nextRunAt        DateTime?               @map("next_run_at")
  startedAt        DateTime?               @map("started_at")
  lastRunAt        DateTime?               @map("last_run_at")
  pausedAt         DateTime?               @map("paused_at")
  completedAt      DateTime?               @map("completed_at")
  createdBy        String?                 @map("created_by") @db.Uuid
  createdAt        DateTime                @default(now()) @map("created_at")
  updatedAt        DateTime                @updatedAt @map("updated_at")

  // Relations
  messages      TelnyxMessage[] @relation("AutomationMessages")
  createdByUser User?           @relation("UserAutomations", fields: [createdBy], references: [id], onDelete: SetNull)
  Pipeline      Pipeline?       @relation(fields: [pipelineId], references: [id])
  pipelineId    String?         @db.Uuid

  @@map("text_automations")
}

// ==========================================
// Text Campaign (Power Dialer for SMS)
// ==========================================

model TextCampaign {
  id     String @id @default(uuid()) @db.Uuid
  userId String @map("user_id") @db.Uuid
  user   User   @relation("UserTextCampaigns", fields: [userId], references: [id], onDelete: Cascade)

  // Campaign metadata
  name        String
  description String?

  // Campaign status
  status TextCampaignStatus @default(IDLE)

  // Configuration
  delaySeconds     Int      @default(2) @map("delay_seconds") // Delay between messages
  maxRounds        Int      @default(1) @map("max_rounds") // Number of rounds (templates)
  currentRound     Int      @default(1) @map("current_round") // Current round being sent
  currentIndex     Int      @default(0) @map("current_index") // Current position in queue
  selectedNumbers  String[] @map("selected_numbers") // DIDs to use for outbound

  // Tag-based filtering (like Power Dialer)
  includeTagIds String[] @default([]) @map("include_tag_ids")
  excludeTagIds String[] @default([]) @map("exclude_tag_ids")

  // Templates for each round (JSON array of template objects)
  // Format: [{ round: 1, templateId: "uuid", content: "message" }, ...]
  templates Json @default("[]")

  // Phone number assignment tracking (JSON object)
  // Format: { "contactId": "phoneNumber", ... } - which DID is assigned to each contact
  phoneAssignments Json @default("{}") @map("phone_assignments")

  // Progress tracking
  totalContacts  Int @default(0) @map("total_contacts")
  sentCount      Int @default(0) @map("sent_count")
  deliveredCount Int @default(0) @map("delivered_count")
  failedCount    Int @default(0) @map("failed_count")
  respondedCount Int @default(0) @map("responded_count")

  // Timestamps
  startedAt   DateTime? @map("started_at")
  pausedAt    DateTime? @map("paused_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  queueItems TextCampaignQueue[]
  messages   TextCampaignMessage[]
  Pipeline   Pipeline?             @relation(fields: [pipelineId], references: [id])
  pipelineId String?               @db.Uuid

  @@index([userId, status])
  @@index([createdAt(sort: Desc)])
  @@map("text_campaigns")
}

model TextCampaignQueue {
  id         String       @id @default(uuid()) @db.Uuid
  campaignId String       @map("campaign_id") @db.Uuid
  campaign   TextCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  contactId String  @map("contact_id") @db.Uuid
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Queue status
  status   TextCampaignQueueStatus @default(PENDING)
  priority Int                     @default(0) // Higher = sent first

  // Round tracking
  currentRound Int @default(1) @map("current_round") // Which round this contact is on

  // Assigned phone number (sticky - same number for all rounds)
  assignedNumber String? @map("assigned_number")

  // Tracking
  attemptCount Int       @default(0) @map("attempt_count")
  lastSentAt   DateTime? @map("last_sent_at")
  respondedAt  DateTime? @map("responded_at") // When they replied (removes from queue)

  // Timestamps
  addedAt     DateTime  @default(now()) @map("added_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  messages TextCampaignMessage[]

  @@unique([campaignId, contactId])
  @@index([campaignId, status])
  @@index([campaignId, currentRound])
  @@map("text_campaign_queue")
}

model TextCampaignMessage {
  id         String       @id @default(uuid()) @db.Uuid
  campaignId String       @map("campaign_id") @db.Uuid
  campaign   TextCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  queueItemId String            @map("queue_item_id") @db.Uuid
  queueItem   TextCampaignQueue @relation(fields: [queueItemId], references: [id], onDelete: Cascade)

  contactId String  @map("contact_id") @db.Uuid
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Message details
  fromNumber String @map("from_number")
  toNumber   String @map("to_number")
  content    String @db.Text
  round      Int    @default(1) // Which round this message belongs to

  // Telnyx tracking
  telnyxMessageId String? @map("telnyx_message_id")

  // Status
  status        TextCampaignMessageStatus @default(PENDING)
  deliveryError String?                   @map("delivery_error")

  // Timestamps
  sentAt      DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([campaignId, status])
  @@index([campaignId, round])
  @@index([contactId])
  @@map("text_campaign_messages")
}

enum TextCampaignStatus {
  IDLE
  RUNNING
  PAUSED
  ROUND_COMPLETE // Waiting to start next round
  COMPLETED
  STOPPED
}

enum TextCampaignQueueStatus {
  PENDING
  SENDING
  SENT
  RESPONDED // Contact replied - removed from queue
  FAILED
  SKIPPED
}

enum TextCampaignMessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

enum TextBlastStatus {
  draft
  pending
  running
  paused
  completed
  failed
  cancelled
}

enum TextAutomationStatus {
  draft
  running
  paused
  completed
  stopped
  failed
}

enum TextAutomationDelayUnit {
  hours
  days
  weeks
  months
}

enum DealStatus {
  lead
  qualified
  proposal
  negotiation
  closed_won
  closed_lost
}

enum MessageType {
  sms
  mms
}

enum MessageDirection {
  inbound
  outbound
}

enum MessageStatus {
  sent
  delivered
  read
  failed
  pending
}

enum CallDirection {
  inbound
  outbound
}

enum CallStatus {
  completed
  missed
  voicemail
  failed
  busy
  no_answer
  cancelled
}

enum CallType {
  voice
  conference
  forwarded
}

enum EmailDirection {
  inbound
  outbound
}

enum EmailStatus {
  sent
  delivered
  read
  failed
  bounced
  spam
  pending
}

enum ActivityType {
  call
  meeting
  email
  text
  task
  note
  follow_up
  appointment
  demo
}

enum ActivityStatus {
  planned
  in_progress
  completed
  cancelled
  overdue
}

enum ActivityPriority {
  low
  medium
  high
  urgent
}

enum DealStage {
  lead
  qualified
  proposal
  negotiation
  contract
  closing
  closed_won
  closed_lost
}

enum DocumentType {
  contract
  invoice
  receipt
  photo
  document
  presentation
  spreadsheet
  other
}

enum ConversationChannel {
  sms
  whatsapp
  email
  voice
}

enum ConversationStatus {
  active
  closed
  spam
  blocked
}

enum ConversationPriority {
  low
  normal
  high
  urgent
}

enum AssistantModelProvider {
  openai
  anthropic
  together_ai
  anyscale
}

enum AssistantVoiceProvider {
  elevenlabs @map("11labs")
  playht
  rime_ai
  neets
  openai_tts @map("openai")
}

enum PhoneNumberProvider {
  twilio
  vonage
  vapi
}

enum VapiCallType {
  inboundPhoneCall
  outboundPhoneCall
  webCall
}

enum VapiCallStatus {
  queued
  ringing
  in_progress
  forwarding
  ended
}

enum VapiCallProvider {
  twilio
  vonage
  vapi
}

enum VapiCallTransport {
  sip
  pstn
}

enum TelnyxMessageStatus {
  queued
  sending
  sent
  delivered
  delivery_failed
  failed
  received
}

enum TelnyxCallStatus {
  initiated
  ringing
  answered
  bridged
  hangup
  failed
}

enum TelnyxBillingType {
  sms
  call
  number_rental
}

enum EmailEncryptionType {
  SSL
  TLS
  NONE
}

enum EmailAccountStatus {
  active
  inactive
  error
}

enum UserRole {
  ADMIN      // Full access to all sections and features
  PROCESSOR  // Configurable section access + phone number access
  ORIGINATOR // Configurable section access + phone number access
}

enum UserStatus {
  active
  inactive
  suspended
}

enum EmailMessageStatus {
  draft
  sent
  delivered
  failed
  bounced
}

model EmailAccount {
  id           String @id @default(uuid()) @db.Uuid
  emailAddress String @unique @map("email_address")
  displayName  String @map("display_name")

  // SMTP Settings (Outgoing)
  smtpHost       String              @map("smtp_host")
  smtpPort       Int                 @map("smtp_port")
  smtpEncryption EmailEncryptionType @map("smtp_encryption")
  smtpUsername   String              @map("smtp_username")
  smtpPassword   String              @map("smtp_password") // Encrypted

  // IMAP Settings (Incoming)
  imapHost       String?              @map("imap_host")
  imapPort       Int?                 @map("imap_port")
  imapEncryption EmailEncryptionType? @map("imap_encryption")
  imapUsername   String?              @map("imap_username")
  imapPassword   String?              @map("imap_password") // Encrypted

  // Additional Settings
  signature  String?
  isDefault  Boolean            @default(false) @map("is_default")
  status     EmailAccountStatus @default(active)
  lastSyncAt DateTime?          @map("last_sync_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  sentEmails    EmailMessage[] @relation("SentEmails")
  emailBlasts   EmailBlast[]
  assignedUsers User[]

  @@map("email_accounts")
}

model EmailMessage {
  id             String  @id @default(uuid()) @db.Uuid
  messageId      String? @unique @map("message_id") // Email Message-ID header
  contactId      String? @map("contact_id") @db.Uuid
  emailAccountId String  @map("email_account_id") @db.Uuid
  sentBy         String? @map("sent_by") @db.Uuid

  // Email Details
  fromEmail String   @map("from_email")
  fromName  String?  @map("from_name")
  toEmails  String[] @map("to_emails")
  ccEmails  String[] @default([]) @map("cc_emails")
  bccEmails String[] @default([]) @map("bcc_emails")

  subject     String
  content     String // HTML content
  textContent String? @map("text_content") // Plain text version

  // Message Properties
  direction MessageDirection
  status    EmailMessageStatus @default(draft)
  priority  String?            @default("normal")

  // Tracking
  sentAt      DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  openedAt    DateTime? @map("opened_at")
  clickedAt   DateTime? @map("clicked_at")

  // Blast Association
  blastId String? @map("blast_id") @db.Uuid

  // Email Threading
  threadId   String?  @map("thread_id") // Thread identifier for grouping related emails
  inReplyTo  String?  @map("in_reply_to") // Message-ID of the email this is replying to
  references String[] @default([]) // Array of Message-IDs in the thread

  // Metadata
  headers     Json? // Email headers
  attachments Json? // Attachment info

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  contact      Contact?     @relation(fields: [contactId], references: [id], onDelete: SetNull)
  emailAccount EmailAccount @relation("SentEmails", fields: [emailAccountId], references: [id], onDelete: Cascade)
  blast        EmailBlast?  @relation(fields: [blastId], references: [id], onDelete: SetNull)
  sentByUser   User?        @relation("UserEmails", fields: [sentBy], references: [id], onDelete: SetNull)

  @@map("email_messages")
}

model EmailConversation {
  id           String @id @default(uuid()) @db.Uuid
  contactId    String @map("contact_id") @db.Uuid
  emailAddress String @map("email_address")

  lastMessageId        String?           @map("last_message_id") @db.Uuid
  lastMessageContent   String?           @map("last_message_content")
  lastMessageAt        DateTime?         @map("last_message_at")
  lastMessageDirection MessageDirection? @map("last_message_direction")

  messageCount Int @default(0) @map("message_count")
  unreadCount  Int @default(0) @map("unread_count")

  isArchived Boolean   @default(false) @map("is_archived")
  isStarred  Boolean   @default(false) @map("is_starred")
  deletedAt  DateTime? @map("deleted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([contactId, emailAddress])
  @@map("email_conversations")
}

model EmailTemplate {
  id          String  @id @default(uuid()) @db.Uuid
  name        String
  subject     String
  content     String // HTML content
  textContent String? @map("text_content") // Plain text version
  category    String? @default("general")

  isSystem Boolean @default(false) @map("is_system")
  isActive Boolean @default(true) @map("is_active")

  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  Pipeline   Pipeline? @relation(fields: [pipelineId], references: [id])
  pipelineId String?   @db.Uuid

  @@map("email_templates")
}

model EmailBlast {
  id          String  @id @default(uuid()) @db.Uuid
  name        String?
  subject     String
  content     String // HTML content
  textContent String? @map("text_content")

  emailAccountId String @map("email_account_id") @db.Uuid

  // Recipients - stored as JSON array like text blast
  selectedContacts Json? @map("selected_contacts") // Store contact IDs as JSON array

  // Legacy fields for backwards compatibility
  contactIds String[] @map("contact_ids") @db.Uuid
  ccEmails   String[] @default([]) @map("cc_emails")
  bccEmails  String[] @default([]) @map("bcc_emails")

  // Blast Settings
  delayBetweenEmails Int @default(5) @map("delay_between_emails") // seconds

  // Status
  status        TextBlastStatus @default(draft)
  totalContacts Int             @default(0) @map("total_contacts")
  sentCount     Int             @default(0) @map("sent_count")
  failedCount   Int             @default(0) @map("failed_count")
  currentIndex  Int             @default(0) @map("current_index")
  isPaused      Boolean         @default(false) @map("is_paused")

  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  pausedAt    DateTime? @map("paused_at")
  resumedAt   DateTime? @map("resumed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  emailAccount EmailAccount   @relation(fields: [emailAccountId], references: [id], onDelete: Cascade)
  messages     EmailMessage[]
  createdBy    String?        @map("created_by") @db.Uuid
  createdByUser User?         @relation("UserEmailBlasts", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdBy])
  @@index([createdAt(sort: Desc)])
  @@map("email_blasts")
}

model User {
  id        String     @id @default(uuid()) @db.Uuid
  email     String     @unique
  firstName String     @map("first_name")
  lastName  String     @map("last_name")
  password  String // Hashed password
  role      UserRole   @default(PROCESSOR)
  status    UserStatus @default(active)

  // Role-based section access (for PROCESSOR and ORIGINATOR roles)
  // Stores array of allowed sections: ["contacts", "tasks", "deals", "calls", "text-center", "loan-copilot", "power-dialer", "settings"]
  allowedSections String[] @default([]) @map("allowed_sections")

  // Admin relationship
  adminId   String? @map("admin_id") @db.Uuid
  admin     User?   @relation("AdminTeam", fields: [adminId], references: [id], onDelete: Cascade)
  teamUsers User[]  @relation("AdminTeam")

  // Assigned resources for team users
  assignedPhoneNumber String?       @map("assigned_phone_number")
  assignedEmailId     String?       @map("assigned_email_id") @db.Uuid
  assignedEmail       EmailAccount? @relation(fields: [assignedEmailId], references: [id], onDelete: SetNull)

  // Telnyx phone number permissions
  defaultPhoneNumberId String?            @map("default_phone_number_id") @db.Uuid
  defaultPhoneNumber   TelnyxPhoneNumber? @relation("DefaultPhoneNumber", fields: [defaultPhoneNumberId], references: [id], onDelete: SetNull)

  // Profile settings
  avatar          String?
  timezone        String?   @default("UTC")
  lastLoginAt     DateTime? @map("last_login_at")
  cellPhoneNumber String?   @map("cell_phone_number") // User's personal cell for click-to-call-via-cell

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  sessions            Session[]
  assignedContacts    ContactAssignment[]
  assignedContactsBy  ContactAssignment[]  @relation("AssignedBy")
  activities          Activity[]           @relation("UserActivities")
  assignedTasks       Activity[]           @relation("AssignedTasks")
  sentMessages        Message[]            @relation("UserMessages")
  sentEmails          EmailMessage[]       @relation("UserEmails")
  calls               TelnyxCall[]         @relation("UserCalls")
  accounts            Account[]            @relation("UserAccounts")
  automations         TextAutomation[]     @relation("UserAutomations")
  filterPresets       FilterPreset[]       @relation("UserFilterPresets")
  powerDialerSessions PowerDialerSession[] @relation("PowerDialerSessions")
  powerDialerLists    PowerDialerList[]    @relation("PowerDialerLists")
  powerDialerRuns     PowerDialerRun[]     @relation("PowerDialerRuns")
  taskReplies         TaskReply[]          @relation("UserTaskReplies")

  // Task-related relations
  taskTemplates     TaskTemplate[]     @relation("UserTaskTemplates")
  taskComments      TaskComment[]      @relation("UserTaskComments")
  taskAttachments   TaskAttachment[]   @relation("UserTaskAttachments")
  taskTimeEntries   TaskTimeEntry[]    @relation("UserTaskTimeEntries")
  taskNotifications TaskNotification[] @relation("UserTaskNotifications")
  taskWorkflows     TaskWorkflow[]     @relation("UserTaskWorkflows")
  settings          UserSettings?      @relation("UserSettings")

  // Pipeline-related relations
  pipelineSettings UserPipelineSettings[] @relation("UserPipelineSettings")
  activePipeline   UserActivePipeline?    @relation("UserActivePipeline")

  // Telnyx phone number permissions
  allowedPhoneNumbers UserAllowedPhoneNumber[] @relation("UserAllowedNumbers")

  // Text blast relations
  textBlasts TextBlast[] @relation("UserTextBlasts")

  // Text campaign relations
  textCampaigns TextCampaign[] @relation("UserTextCampaigns")

  // Email blast relations
  emailBlasts EmailBlast[] @relation("UserEmailBlasts")

  // Sequence relations
  sequences            Sequence[]           @relation("UserSequences")
  enrolledSequences    SequenceEnrollment[] @relation("UserEnrolledSequences")

  // Scheduled messages
  scheduledMessages    ScheduledMessage[]   @relation("UserScheduledMessages")

  // Click to call via cell
  clickToCallPending   ClickToCallPending[] @relation("UserClickToCallPending")

  // Voicemail messages for voicemail drop
  voicemailMessages    VoicemailMessage[]

  @@map("users")
}

model FilterPreset {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  description String?
  filters     Json // Store filter configuration as JSON
  userId      String    @map("user_id") @db.Uuid
  user        User      @relation("UserFilterPresets", fields: [userId], references: [id], onDelete: Cascade)
  isDefault   Boolean   @default(false) @map("is_default")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  Pipeline    Pipeline? @relation(fields: [pipelineId], references: [id])
  pipelineId  String?   @db.Uuid

  @@index([userId])
  @@map("filter_presets")
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  sessionToken String   @unique @map("session_token")
  expires      DateTime

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model ContactAssignment {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  contactId  String   @map("contact_id") @db.Uuid
  assignedBy String   @map("assigned_by") @db.Uuid
  assignedAt DateTime @default(now()) @map("assigned_at")

  // Relations
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact        Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  assignedByUser User    @relation("AssignedBy", fields: [assignedBy], references: [id], onDelete: Cascade)

  @@unique([userId, contactId])
  @@index([userId], name: "idx_contact_assignments_user")
  @@index([contactId], name: "idx_contact_assignments_contact")
  @@index([assignedBy], name: "idx_contact_assignments_assigned_by")
  @@map("contact_assignments")
}

model Account {
  id                String  @id @default(uuid()) @db.Uuid
  userId            String  @map("user_id") @db.Uuid
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation("UserAccounts", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Power Dialer Models
model PowerDialerSession {
  id     String @id @default(uuid()) @db.Uuid
  userId String @map("user_id") @db.Uuid
  user   User   @relation("PowerDialerSessions", fields: [userId], references: [id], onDelete: Cascade)

  // Link to named list (optional - session can be standalone or from a list)
  listId String?          @map("list_id") @db.Uuid
  list   PowerDialerList? @relation(fields: [listId], references: [id], onDelete: SetNull)

  // Session configuration
  concurrentLines Int      @default(1) @map("concurrent_lines")
  selectedNumbers String[] @map("selected_numbers") // Array of phone numbers to use for outbound

  // Session status
  status PowerDialerStatus @default(IDLE)

  // Statistics
  totalCalls     Int @default(0) @map("total_calls")
  totalContacted Int @default(0) @map("total_contacted")
  totalAnswered  Int @default(0) @map("total_answered")
  totalNoAnswer  Int @default(0) @map("total_no_answer")
  totalTalkTime  Int @default(0) @map("total_talk_time") // in seconds

  // Timestamps
  startedAt   DateTime? @map("started_at")
  pausedAt    DateTime? @map("paused_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  queueItems PowerDialerQueue[]
  calls      PowerDialerCall[]

  @@index([userId, status])
  @@index([createdAt(sort: Desc)])
  @@map("power_dialer_sessions")
}

model PowerDialerQueue {
  id        String             @id @default(uuid()) @db.Uuid
  sessionId String             @map("session_id") @db.Uuid
  session   PowerDialerSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  contactId String  @map("contact_id") @db.Uuid
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Queue status
  status   QueueItemStatus @default(PENDING)
  priority Int             @default(0) // Higher priority = called first

  // Retry tracking
  attemptCount  Int       @default(0) @map("attempt_count")
  maxAttempts   Int       @default(3) @map("max_attempts")
  lastAttemptAt DateTime? @map("last_attempt_at")

  // Result tracking
  wasContacted Boolean @default(false) @map("was_contacted")
  wasAnswered  Boolean @default(false) @map("was_answered")
  callOutcome  String? @map("call_outcome") // NO_ANSWER, BUSY, ANSWERED, FAILED, etc.

  // Timestamps
  addedAt     DateTime  @default(now()) @map("added_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  calls PowerDialerCall[]

  @@index([sessionId, status])
  @@index([sessionId, priority(sort: Desc)])
  @@map("power_dialer_queue")
}

model PowerDialerCall {
  id        String             @id @default(uuid()) @db.Uuid
  sessionId String             @map("session_id") @db.Uuid
  session   PowerDialerSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  queueItemId String           @map("queue_item_id") @db.Uuid
  queueItem   PowerDialerQueue @relation(fields: [queueItemId], references: [id], onDelete: Cascade)

  contactId String  @map("contact_id") @db.Uuid
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Call details
  fromNumber String @map("from_number")
  toNumber   String @map("to_number")

  // Call tracking
  webrtcSessionId String? @map("webrtc_session_id")
  telnyxCallId    String? @map("telnyx_call_id")
  callControlId   String? @map("call_control_id") // Telnyx Call Control ID for AMD calls

  // AMD (Answering Machine Detection)
  amdResult    String? @map("amd_result") // human, machine, fax, unknown
  hangupCause  String? @map("hangup_cause")

  // Call status
  status PowerDialerCallStatus @default(INITIATED)

  // Call outcome
  answered    Boolean @default(false)
  droppedBusy Boolean @default(false) @map("dropped_busy") // Dropped because admin was busy
  duration    Int? // in seconds

  // Call outcome & notes
  callOutcome      String?   @map("call_outcome")
  callNotes        String?   @map("call_notes")
  dispositionSetAt DateTime? @map("disposition_set_at") @db.Timestamptz(6)

  // Sentiment analysis
  sentiment        String?
  sentimentScore   Int?    @map("sentiment_score")
  sentimentSummary String? @map("sentiment_summary")

  // Timestamps
  initiatedAt DateTime  @default(now()) @map("initiated_at")
  answeredAt  DateTime? @map("answered_at")
  endedAt     DateTime? @map("ended_at")

  @@index([sessionId, status])
  @@index([queueItemId])
  @@index([contactId])
  @@index([callControlId], name: "idx_power_dialer_calls_call_control_id")
  @@index([callOutcome], name: "idx_power_dialer_calls_outcome")
  @@index([sentiment], name: "idx_power_dialer_calls_sentiment")
  @@map("power_dialer_calls")
}

enum PowerDialerStatus {
  IDLE
  RUNNING
  PAUSED
  COMPLETED
  STOPPED
}

enum QueueItemStatus {
  PENDING
  CALLING
  COMPLETED
  FAILED
  SKIPPED
}

enum PowerDialerCallStatus {
  INITIATED
  RINGING
  ANSWERED
  BUSY
  NO_ANSWER
  FAILED
  COMPLETED
}

enum PowerDialerListStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum PowerDialerListContactStatus {
  PENDING
  CALLED
  ANSWERED
  NO_ANSWER
  FAILED
  COMPLETED  // Dispositioned and done
  SKIPPED    // Manually skipped
  REMOVED    // Removed from queue (DNC, bad number, etc.)
}

// Power Dialer Named Lists - Persistent call lists that can span multiple sessions
model PowerDialerList {
  id     String @id @default(uuid()) @db.Uuid
  userId String @map("user_id") @db.Uuid
  user   User   @relation("PowerDialerLists", fields: [userId], references: [id], onDelete: Cascade)

  // List metadata
  name        String // User-defined name (e.g., "Hot Leads - January")
  description String? // Optional description

  // List status
  status PowerDialerListStatus @default(ACTIVE)

  // Multi-line dialer configuration
  maxLines         Int     @default(3) @map("max_lines") // Default concurrent lines
  callerIdStrategy String  @default("round_robin") @map("caller_id_strategy") // round_robin, single_number, random
  currentIndex     Int     @default(0) @map("current_index") // Resume position

  // Dynamic tag-based sync configuration
  syncTagIds    String[]  @default([]) @map("sync_tag_ids") // Tag IDs to sync contacts from
  excludeTagIds String[]  @default([]) @map("exclude_tag_ids") // Tag IDs to exclude from sync
  autoSync      Boolean   @default(false) @map("auto_sync") // Whether to auto-sync every minute
  lastSyncAt    DateTime? @map("last_sync_at") // Last time contacts were synced from tags
  syncIntervalMinutes Int @default(1) @map("sync_interval_minutes") // How often to sync (default 1 min)

  // Progress tracking
  totalContacts    Int @default(0) @map("total_contacts")
  contactsCalled   Int @default(0) @map("contacts_called")
  contactsAnswered Int @default(0) @map("contacts_answered")
  contactsNoAnswer Int @default(0) @map("contacts_no_answer")
  contactsVoicemail Int @default(0) @map("contacts_voicemail")
  contactsBusy     Int @default(0) @map("contacts_busy")
  contactsFailed   Int @default(0) @map("contacts_failed")
  totalTalkTime    Int @default(0) @map("total_talk_time") // in seconds

  // Session state persistence (stores session history JSON for resume)
  sessionState Json? @map("session_state") // Stores { sessionHistory: [], queueOrder: [] }

  // Timestamps
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastWorkedOn DateTime? @map("last_worked_on") // Last time dialing was done on this list
  completedAt  DateTime? @map("completed_at") // When list was marked complete

  // Optional call script for this list
  scriptId String?     @map("script_id") @db.Uuid
  script   CallScript? @relation("PowerDialerListScript", fields: [scriptId], references: [id], onDelete: SetNull)

  // Relations
  contacts   PowerDialerListContact[]
  sessions   PowerDialerSession[]
  runs       PowerDialerRun[]
  Pipeline   Pipeline?                @relation(fields: [pipelineId], references: [id])
  pipelineId String?                  @db.Uuid

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, lastWorkedOn(sort: Desc)])
  @@index([autoSync, lastSyncAt]) // For finding lists needing sync
  @@map("power_dialer_lists")
}

// Many-to-many relationship between PowerDialerList and Contact
model PowerDialerListContact {
  id     String          @id @default(uuid()) @db.Uuid
  listId String          @map("list_id") @db.Uuid
  list   PowerDialerList @relation(fields: [listId], references: [id], onDelete: Cascade)

  contactId String  @map("contact_id") @db.Uuid
  contact   Contact @relation("PowerDialerListContacts", fields: [contactId], references: [id], onDelete: Cascade)

  // Contact status in list
  status       PowerDialerListContactStatus @default(PENDING)
  attemptCount Int                          @default(0) @map("attempt_count")
  lastCalledAt DateTime?                    @map("last_called_at")
  disposition  String?                      // Disposition name from last call

  // Timestamps
  addedAt DateTime @default(now()) @map("added_at")

  // Link to run legs for this contact
  runLegs PowerDialerRunLeg[]

  @@unique([listId, contactId])
  @@index([listId, status])
  @@index([listId, lastCalledAt(sort: Desc)])
  @@map("power_dialer_list_contacts")
}

// Multi-Line Power Dialer Run - Tracks an active dialing session
model PowerDialerRun {
  id     String          @id @default(uuid()) @db.Uuid
  listId String          @map("list_id") @db.Uuid
  list   PowerDialerList @relation(fields: [listId], references: [id], onDelete: Cascade)
  userId String          @map("user_id") @db.Uuid
  user   User            @relation("PowerDialerRuns", fields: [userId], references: [id], onDelete: Cascade)

  // Run configuration
  maxLines         Int      @default(3) @map("max_lines")
  selectedNumbers  String[] @map("selected_numbers") // DIDs being used for this run
  callerIdStrategy String   @default("round_robin") @map("caller_id_strategy")
  scriptId         String?  @map("script_id") @db.Uuid

  // Run status
  status String @default("idle") // idle, running, paused, completed, error

  // Progress
  currentIndex   Int @default(0) @map("current_index")
  totalContacts  Int @default(0) @map("total_contacts")
  totalAttempted Int @default(0) @map("total_attempted")
  totalAnswered  Int @default(0) @map("total_answered")
  totalNoAnswer  Int @default(0) @map("total_no_answer")
  totalVoicemail Int @default(0) @map("total_voicemail")
  totalBusy      Int @default(0) @map("total_busy")
  totalFailed    Int @default(0) @map("total_failed")
  totalCanceled  Int @default(0) @map("total_canceled") // Canceled because another answered
  totalTalkTime  Int @default(0) @map("total_talk_time") // in seconds

  // Timestamps
  startedAt   DateTime? @map("started_at")
  pausedAt    DateTime? @map("paused_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  legs PowerDialerRunLeg[]

  @@index([listId, status])
  @@index([userId, createdAt(sort: Desc)])
  @@map("power_dialer_runs")
}

// Individual call leg within a multi-line dialer run
model PowerDialerRunLeg {
  id    String         @id @default(uuid()) @db.Uuid
  runId String         @map("run_id") @db.Uuid
  run   PowerDialerRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  // Contact being called
  listContactId String                 @map("list_contact_id") @db.Uuid
  listContact   PowerDialerListContact @relation(fields: [listContactId], references: [id], onDelete: Cascade)

  // Telnyx tracking
  telnyxCallControlId String? @map("telnyx_call_control_id")
  telnyxSessionId     String? @map("telnyx_session_id")

  // Call details
  fromNumber String @map("from_number")
  toNumber   String @map("to_number")
  lineNumber Int    @map("line_number") // 1..maxLines slot

  // Status
  status         String  @default("queued") // queued, dialing, ringing, amd_check, answered, voicemail, machine, no_answer, busy, failed, canceled_other_answer
  amdResult      String? @map("amd_result") // human, machine, fax, unknown
  hangupCause    String? @map("hangup_cause")
  sipResponseCode Int?   @map("sip_response_code")

  // Timing
  ringDurationMs Int? @map("ring_duration_ms")
  talkDurationMs Int? @map("talk_duration_ms")

  // Timestamps
  startedAt  DateTime  @default(now()) @map("started_at")
  answeredAt DateTime? @map("answered_at")
  endedAt    DateTime? @map("ended_at")

  @@index([runId, status])
  @@index([telnyxCallControlId])
  @@map("power_dialer_run_legs")
}

// Call Scripts for Autodialer Campaigns
model CallScript {
  id          String  @id @default(uuid()) @db.Uuid
  name        String
  description String?
  content     String  @db.Text // The script content with variable placeholders like {firstName}
  variables   Json    @default("[]") // Array of variable names used in the script
  isActive    Boolean @default(true) @map("is_active")
  usageCount  Int     @default(0) @map("usage_count")

  // Pipeline association
  pipelineId String?   @map("pipeline_id") @db.Uuid
  pipeline   Pipeline? @relation(fields: [pipelineId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  campaigns        CallCampaign[]
  powerDialerLists PowerDialerList[] @relation("PowerDialerListScript")

  @@index([pipelineId])
  @@index([isActive])
  @@map("call_scripts")
}

// Voicemail Message - Pre-recorded voicemail messages for voicemail drop feature
model VoicemailMessage {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  // Display name for the voicemail (e.g., "Introduction", "Follow-up")
  description String? // Optional description

  // Audio file storage (local file path on VPS)
  filePath    String  @map("file_path") // Path to audio file on server
  fileName    String  @map("file_name") // Original file name
  fileSize    Int     @map("file_size") // File size in bytes
  duration    Int?    // Duration in seconds (optional, can be calculated)
  mimeType    String  @default("audio/wav") @map("mime_type")

  // Status
  isActive    Boolean @default(true) @map("is_active")
  isDefault   Boolean @default(false) @map("is_default") // Default voicemail to use
  usageCount  Int     @default(0) @map("usage_count")

  // Owner (admin account)
  userId      String  @map("user_id") @db.Uuid
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([isActive])
  @@map("voicemail_messages")
}

// Call Campaign - Organizes contacts for autodialer with script and dispositions
model CallCampaign {
  id          String  @id @default(uuid()) @db.Uuid
  name        String
  description String?

  // Script association
  scriptId String?     @map("script_id") @db.Uuid
  script   CallScript? @relation(fields: [scriptId], references: [id], onDelete: SetNull)

  // Campaign configuration
  dispositions Json @default("[]") // Array of disposition options like ["Interested", "Not Interested", "Callback", "Wrong Number"]

  // Phone numbers to use
  senderNumbers Json @map("sender_numbers") // Array of phone number objects

  // Campaign status
  status CallCampaignStatus @default(draft)

  // Statistics
  totalContacts    Int @default(0) @map("total_contacts")
  contactsCalled   Int @default(0) @map("contacts_called")
  contactsAnswered Int @default(0) @map("contacts_answered")
  contactsNoAnswer Int @default(0) @map("contacts_no_answer")
  totalTalkTime    Int @default(0) @map("total_talk_time") // in seconds

  // Pipeline association
  pipelineId String?   @map("pipeline_id") @db.Uuid
  pipeline   Pipeline? @relation(fields: [pipelineId], references: [id], onDelete: SetNull)

  // Timestamps
  startedAt   DateTime? @map("started_at")
  pausedAt    DateTime? @map("paused_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  contacts CallCampaignContact[]

  @@index([pipelineId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("call_campaigns")
}

// Call Campaign Contact - Tracks each contact in a campaign
model CallCampaignContact {
  id         String       @id @default(uuid()) @db.Uuid
  campaignId String       @map("campaign_id") @db.Uuid
  campaign   CallCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  contactId String  @map("contact_id") @db.Uuid
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Contact status in campaign
  status       CallCampaignContactStatus @default(pending)
  attemptCount Int                       @default(0) @map("attempt_count")
  maxAttempts  Int                       @default(3) @map("max_attempts")

  // Call outcome
  disposition String? // The selected disposition
  notes       String? @db.Text
  callDuration Int?   @map("call_duration") // in seconds

  // Timestamps
  lastCalledAt DateTime? @map("last_called_at")
  completedAt  DateTime? @map("completed_at")
  addedAt      DateTime  @default(now()) @map("added_at")

  @@unique([campaignId, contactId])
  @@index([campaignId, status])
  @@index([campaignId, lastCalledAt(sort: Desc)])
  @@map("call_campaign_contacts")
}

enum CallCampaignStatus {
  draft
  pending
  running
  paused
  completed
  cancelled
}

enum CallCampaignContactStatus {
  pending
  calling
  completed
  failed
  skipped
  callback
}

model Funder {
  id                String   @id @default(uuid()) @db.Uuid
  name              String   @unique
  description       String?
  requiredDocuments String[] @default([])
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
}

// Enum for custom field types
enum FieldType {
  text
  textarea
  number
  decimal
  date
  datetime
  boolean
  select
  multiselect
  phone
  email
  url
  currency
}

model UserSettings {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @map("user_id") @db.Uuid
  taskTypes String[] @default([]) @map("task_types")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation("UserSettings", fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// Pipeline model - represents different business pipelines
model Pipeline {
  id           String   @id @default(uuid()) @db.Uuid
  name         String   @db.VarChar(255)
  description  String?
  color        String?  @default("#3B82F6") @db.VarChar(50)
  icon         String?  @default("briefcase") @db.VarChar(50)
  isActive     Boolean  @default(true) @map("is_active")
  isDefault    Boolean  @default(false) @map("is_default")
  isLoanPipeline Boolean @default(false) @map("is_loan_pipeline") // Flag for loan processing pipelines
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  contacts             Contact[]
  activities           Activity[]
  messageTemplates     MessageTemplate[]
  emailTemplates       EmailTemplate[]
  taskTemplates        TaskTemplate[]
  deals                Deal[]
  tags                 Tag[]
  textBlasts           TextBlast[]
  textCampaigns        TextCampaign[]
  textAutomations      TextAutomation[]
  filterPresets        FilterPreset[]
  powerDialerLists     PowerDialerList[]
  userPipelineSettings UserPipelineSettings[]
  userActivePipelines  UserActivePipeline[]
  callScripts          CallScript[]
  callCampaigns        CallCampaign[]
  stages               DealPipelineStage[]    @relation("PipelineStages") // Pipeline stages with probabilities
  sequences            Sequence[]

  @@map("pipelines")
}

// User-specific settings per pipeline
model UserPipelineSettings {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  pipelineId     String   @map("pipeline_id") @db.Uuid
  taskTypes      String[] @default([]) @map("task_types")
  customSettings Json     @default("{}") @map("custom_settings")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user     User     @relation("UserPipelineSettings", fields: [userId], references: [id], onDelete: Cascade)
  pipeline Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  @@unique([userId, pipelineId])
  @@index([userId])
  @@index([pipelineId])
  @@map("user_pipeline_settings")
}

// Tracks which pipeline each user is currently viewing
model UserActivePipeline {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @unique @map("user_id") @db.Uuid
  pipelineId String   @map("pipeline_id") @db.Uuid
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user     User     @relation("UserActivePipeline", fields: [userId], references: [id], onDelete: Cascade)
  pipeline Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_active_pipeline")
}

// Lender model - represents funders/lenders for loan deals
model Lender {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(255)
  type      String?  @db.VarChar(100) // e.g. "Private Lender", "DSCR Lender", "Hard Money"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  deals Deal[] @relation("DealLender")

  @@map("lenders")
}

// ============================================================================
// SEQUENCE MODELS - Sales/Marketing Cadence Automation (like Salesloft/Outreach)
// ============================================================================

enum SequenceStepType {
  EMAIL
  SMS
  TASK
  WAIT           // Wait for condition (reply, open, etc.)
  VOICEMAIL_DROP // Future
  AI_CALL        // Future
}

enum SequenceStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELED
}

// Sequence - A reusable cadence of steps (emails, SMS, tasks, etc.)
model Sequence {
  id          String   @id @default(uuid()) @db.Uuid
  pipelineId  String?  @map("pipeline_id") @db.Uuid
  name        String
  description String?
  isActive    Boolean  @default(true) @map("is_active")

  createdById String   @map("created_by_id") @db.Uuid
  createdBy   User     @relation("UserSequences", fields: [createdById], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  pipeline    Pipeline?            @relation(fields: [pipelineId], references: [id], onDelete: SetNull)
  steps       SequenceStep[]
  enrollments SequenceEnrollment[]

  @@index([pipelineId])
  @@index([createdById])
  @@index([isActive])
  @@map("sequences")
}

// SequenceStep - Individual step in a sequence (email, SMS, task, etc.)
model SequenceStep {
  id          String           @id @default(uuid()) @db.Uuid
  sequenceId  String           @map("sequence_id") @db.Uuid
  sequence    Sequence         @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  orderIndex  Int              @map("order_index") // 0,1,2,... for step order
  type        SequenceStepType
  name        String?          // e.g. "Intro email", "Follow-up text"

  // How long after previous step or enrollment (for first step)
  delayMinutes Int             @map("delay_minutes") // number of minutes after previous step

  // Channel-specific config stored as JSON
  // For EMAIL: { templateId, fromEmailAccountId, subjectOverride }
  // For SMS: { templateId, fromNumberId, useContactOwnerDefault }
  // For TASK: { title, description, assigneeType, dueDateOffset }
  config      Json             @default("{}")

  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  logs        SequenceLog[]

  @@index([sequenceId, orderIndex])
  @@map("sequence_steps")
}

// SequenceEnrollment - Tracks a contact's progress through a sequence
model SequenceEnrollment {
  id            String         @id @default(uuid()) @db.Uuid
  sequenceId    String         @map("sequence_id") @db.Uuid
  sequence      Sequence       @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  contactId     String         @map("contact_id") @db.Uuid
  contact       Contact        @relation("ContactSequenceEnrollments", fields: [contactId], references: [id], onDelete: Cascade)

  status        SequenceStatus @default(ACTIVE)

  // When enrollment started
  enrolledAt    DateTime       @default(now()) @map("enrolled_at") @db.Timestamptz(6)

  // For progress tracking
  currentStepIndex Int         @default(0) @map("current_step_index")
  nextStepAt       DateTime?   @map("next_step_at") @db.Timestamptz(6) // When the next step should execute
  lastExecutedAt   DateTime?   @map("last_executed_at") @db.Timestamptz(6)
  completedAt      DateTime?   @map("completed_at") @db.Timestamptz(6)

  // Enrollment metadata
  enrolledById String?        @map("enrolled_by_id") @db.Uuid
  enrolledBy   User?          @relation("UserEnrolledSequences", fields: [enrolledById], references: [id], onDelete: SetNull)

  // Reason for pause/cancel if applicable
  pauseReason  String?        @map("pause_reason")
  cancelReason String?        @map("cancel_reason")

  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  logs         SequenceLog[]

  @@unique([sequenceId, contactId, status]) // Only one ACTIVE enrollment per contact per sequence
  @@index([sequenceId, status])
  @@index([contactId])
  @@index([status, nextStepAt])
  @@index([enrolledById])
  @@map("sequence_enrollments")
}

// SequenceLog - Log of each step execution in an enrollment
model SequenceLog {
  id            String             @id @default(uuid()) @db.Uuid
  enrollmentId  String             @map("enrollment_id") @db.Uuid
  enrollment    SequenceEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  stepId        String             @map("step_id") @db.Uuid
  step          SequenceStep       @relation(fields: [stepId], references: [id], onDelete: Cascade)

  executedAt    DateTime           @default(now()) @map("executed_at") @db.Timestamptz(6)

  // Result of step execution
  // SENT, SKIPPED_NO_PHONE, SKIPPED_NO_EMAIL, SKIPPED_DNC, SKIPPED_UNSUBSCRIBED,
  // SKIPPED_NOT_IMPLEMENTED, FAILED, TASK_CREATED
  result        String
  errorMessage  String?            @map("error_message")

  // ID of the created record (email message, SMS message, or activity/task)
  channelId     String?            @map("channel_id") @db.Uuid

  @@index([enrollmentId])
  @@index([stepId])
  @@index([executedAt(sort: Desc)])
  @@map("sequence_logs")
}

// DealPipelineStage model - represents stages within a pipeline with probabilities
model DealPipelineStage {
  id                 String   @id @default(uuid()) @db.Uuid
  pipelineId         String   @map("pipeline_id") @db.Uuid
  key                String   @db.VarChar(100) // e.g. "new_lead", "qualified", etc.
  label              String   @db.VarChar(255)
  orderIndex         Int      @map("order_index")
  defaultProbability Int      @default(0) @map("default_probability") // 0-100
  isClosedStage      Boolean  @default(false) @map("is_closed_stage")
  isLostStage        Boolean  @default(false) @map("is_lost_stage")
  color              String?  @default("#e5e7eb") @db.VarChar(50)
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  pipeline Pipeline @relation("PipelineStages", fields: [pipelineId], references: [id], onDelete: Cascade)
  deals    Deal[]   @relation("DealPipelineStage")

  @@unique([pipelineId, key])
  @@index([pipelineId, orderIndex])
  @@map("deal_pipeline_stages")
}

// Scheduled Messages - For scheduling SMS/Email sends (manual + sequences)
enum ScheduledChannel {
  SMS
  EMAIL
}

enum ScheduledStatus {
  PENDING
  SENDING
  SENT
  CANCELED
  FAILED
}

model ScheduledMessage {
  id          String           @id @default(uuid()) @db.Uuid
  channel     ScheduledChannel
  status      ScheduledStatus  @default(PENDING)

  // Contact relationship
  contactId   String           @map("contact_id") @db.Uuid
  contact     Contact          @relation("ContactScheduledMessages", fields: [contactId], references: [id], onDelete: Cascade)

  // Who created it (manual user, sequence, etc.)
  createdById String?          @map("created_by_id") @db.Uuid
  createdBy   User?            @relation("UserScheduledMessages", fields: [createdById], references: [id], onDelete: SetNull)

  // When the message should be sent
  scheduledAt DateTime         @map("scheduled_at") @db.Timestamptz(6)

  // When it was actually sent / failed
  sentAt      DateTime?        @map("sent_at") @db.Timestamptz(6)
  failedAt    DateTime?        @map("failed_at") @db.Timestamptz(6)

  // SMS-specific fields
  fromNumber  String?          @map("from_number")
  toNumber    String?          @map("to_number")

  // Email-specific fields
  fromEmail   String?          @map("from_email")
  toEmail     String?          @map("to_email")
  subject     String?

  // Body content (SMS text or Email HTML content)
  body        String           @db.Text

  // Optional metadata: template IDs, sequence step, source info, etc.
  metadata    Json?            @default("{}")

  // Error information if failed
  errorMessage String?         @map("error_message")

  createdAt   DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([status, scheduledAt])
  @@index([contactId])
  @@index([createdById])
  @@index([channel, status])
  @@map("scheduled_messages")
}

// ========================================
// Call Dispositions with Automation Rules
// ========================================

// CallDisposition - Custom dispositions for call outcomes
model CallDisposition {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique // e.g., "Interested", "Not Interested", "Callback", "Wrong Number"
  description String?
  color       String   @default("#6b7280") // Hex color for UI
  icon        String?  // Lucide icon name
  isDefault   Boolean  @default(false) @map("is_default") // System default dispositions
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")

  // Relations
  actions     CallDispositionAction[]
  logs        CallDispositionLog[]

  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isActive, sortOrder])
  @@map("call_dispositions")
}

// CallDispositionAction - Rules/automations triggered by a disposition
model CallDispositionAction {
  id            String          @id @default(uuid()) @db.Uuid
  dispositionId String          @map("disposition_id") @db.Uuid
  disposition   CallDisposition @relation(fields: [dispositionId], references: [id], onDelete: Cascade)

  // Action type
  actionType    DispositionActionType @map("action_type")

  // Action configuration (depends on actionType)
  // For ADD_TAG / REMOVE_TAG: { tagId: "uuid", tagName: "string" }
  // For ADD_TO_DNC: { reason: "string" }
  // For TRIGGER_SEQUENCE: { sequenceId: "uuid" }
  // For SEND_SMS: { templateId: "uuid", phoneNumberId: "uuid" }
  // For SEND_EMAIL: { templateId: "uuid" }
  config        Json            @default("{}")

  sortOrder     Int             @default(0) @map("sort_order")
  isActive      Boolean         @default(true) @map("is_active")

  createdAt     DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([dispositionId, isActive])
  @@map("call_disposition_actions")
}

// CallDispositionLog - Audit log of disposition selections
model CallDispositionLog {
  id            String          @id @default(uuid()) @db.Uuid
  dispositionId String          @map("disposition_id") @db.Uuid
  disposition   CallDisposition @relation(fields: [dispositionId], references: [id])

  contactId     String          @map("contact_id") @db.Uuid
  contact       Contact         @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Call context
  callId        String?         @map("call_id") @db.Uuid // Reference to call log if available
  dialerRunId   String?         @map("dialer_run_id") // Power dialer run ID
  listId        String?         @map("list_id") @db.Uuid // Power dialer list ID

  // User notes
  notes         String?

  // Actions executed
  actionsExecuted Json?         @default("[]") @map("actions_executed") // Array of action results

  createdAt     DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy     String?         @map("created_by") @db.Uuid // User who set the disposition

  @@index([contactId, createdAt(sort: Desc)])
  @@index([dispositionId, createdAt(sort: Desc)])
  @@map("call_disposition_logs")
}

enum DispositionActionType {
  ADD_TAG
  REMOVE_TAG
  ADD_TO_DNC
  REMOVE_FROM_DNC
  TRIGGER_SEQUENCE
  SEND_SMS
  SEND_EMAIL
  UPDATE_DEAL_STAGE
  CREATE_TASK
  REQUEUE_CONTACT      // Put back in queue for retry
  REMOVE_FROM_QUEUE    // Remove from all dialer queues
  MARK_BAD_NUMBER      // Mark phone as invalid
  DELETE_CONTACT       // Permanently delete the contact
}

// ============================================================================
// CLICK-TO-CALL VIA CELL - Tracks pending calls for bridging user's cell to prospect
// ============================================================================

model ClickToCallPending {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  callControlId     String   @unique @map("call_control_id") // Leg A (user's cell) call control ID
  legASessionId     String?  @map("leg_a_session_id") // Telnyx session ID for Leg A
  leadPhone         String   @map("lead_phone") // Prospect's phone to dial on Leg B
  fromTelnyxNumber  String   @map("from_telnyx_number") // Caller ID for both legs
  contactId         String?  @map("contact_id") @db.Uuid // Optional contact association
  userCellNumber    String   @map("user_cell_number") // User's cell number that was called
  status            String   @default("pending") // pending, leg_a_answered, bridging, completed, failed
  legBCallControlId String?  @map("leg_b_call_control_id") // Leg B (prospect) call control ID
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  completedAt       DateTime? @map("completed_at")

  user    User     @relation("UserClickToCallPending", fields: [userId], references: [id], onDelete: Cascade)
  contact Contact? @relation("ContactClickToCallPending", fields: [contactId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([callControlId])
  @@index([status])
  @@map("click_to_call_pending")
}
